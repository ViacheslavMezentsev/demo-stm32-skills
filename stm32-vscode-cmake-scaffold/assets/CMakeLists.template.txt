cmake_minimum_required(VERSION 3.16)

set(CMAKE_TOOLCHAIN_FILE "${CMAKE_CURRENT_SOURCE_DIR}/cmake/gcc-arm-none-eabi.cmake")

set(CMAKE_C_STANDARD 17)
set(CMAKE_CXX_STANDARD 17)

# Имя проекта берется из папки
get_filename_component(BASE_FOLDER ${CMAKE_CURRENT_SOURCE_DIR} NAME)
set(PROJECT_NAME ${BASE_FOLDER})

# Файл конфигурации компоновщика (АГЕНТ ДОЛЖЕН НАЙТИ РЕАЛЬНЫЙ .ld ФАЙЛ В КОРНЕ!)
set(LINKER_FILE "${CMAKE_CURRENT_SOURCE_DIR}/STM32Fxxx_FLASH.ld")

project(${PROJECT_NAME} C CXX ASM)

add_executable(${PROJECT_NAME})

# АГЕНТ ДОЛЖЕН ДОБАВИТЬ ВСЕ .c И .s ФАЙЛЫ ИЗ ПАПОК Core/ И Drivers/
target_sources(${PROJECT_NAME} PRIVATE
    Core/Src/main.c
    Core/Src/stm32fXxx_it.c
    Core/Src/stm32fXxx_hal_msp.c
    Core/Src/system_stm32fXxx.c
    startup_stm32fXxx.s
    # ... Drivers/STM32Fxxx_HAL_Driver/Src/...
)

# АГЕНТ ДОЛЖЕН УКАЗАТЬ ПУТИ ДО ЗАГОЛОВОЧНЫХ ФАЙЛОВ
target_include_directories(${PROJECT_NAME} PRIVATE
    Core/Inc
    Drivers/STM32Fxxx_HAL_Driver/Inc
    Drivers/STM32Fxxx_HAL_Driver/Inc/Legacy
    Drivers/CMSIS/Device/ST/STM32Fxxx/Include
    Drivers/CMSIS/Include
)

target_link_libraries(${PROJECT_NAME} STM32::Nano STM32::NoSys)

# АГЕНТ ДОЛЖЕН УСТАНОВИТЬ ПРАВИЛЬНЫЙ ДЕФАЙН МК
target_compile_definitions(${PROJECT_NAME} PRIVATE STM32FXXXXX USE_HAL_DRIVER)

# АГЕНТ ДОЛЖЕН ПОДСТАВИТЬ АРХИТЕКТУРНЫЕ ФЛАГИ (-mcpu=... -mfloat-abi=... -mfpu=...)
target_compile_options(${PROJECT_NAME} PRIVATE
    -mcpu=cortex-mX -mthumb -mfloat-abi=soft
    -W -Wall -Wextra
    $<$<CONFIG:DEBUG>:-O0>
    $<$<CONFIG:RELEASE>:-Os>
    -ffunction-sections -fdata-sections
    $<$<CONFIG:DEBUG>:-g3>
    -pipe
    $<$<COMPILE_LANGUAGE:CXX>:-fpermissive -fno-exceptions -fno-rtti -funsigned-bitfields -fshort-enums -Winline>
)

# ФЛАГИ АРХИТЕКТУРЫ ЗДЕСЬ ДОЛЖНЫ ПОЛНОСТЬЮ СОВПАДАТЬ С TARGET_COMPILE_OPTIONS!
target_link_options(${PROJECT_NAME} PRIVATE
    -T${LINKER_FILE}
    -mcpu=cortex-mX -mthumb -mfloat-abi=soft
    -lc -lgcc
    -Wl,-Map=${PROJECT_NAME}.map,--no-warn-rwx-segments,--cref,--gc-sections,--print-memory-usage
)

# Артефакты сборки
stm32_print_size_of_target(${PROJECT_NAME})
stm32_generate_binary_file(${PROJECT_NAME})
stm32_generate_hex_file(${PROJECT_NAME})
stm32_generate_lss_file(${PROJECT_NAME})
